
  figure.exploitation.rate = function(p, all.areas=T, outdir, CFA4X.exclude.current.year=T ) {
 
    if (all.areas) {
      areas = c("cfa4x", "cfasouth", "cfanorth" )
      regions = c("4X", "S-ENS", "N-ENS")
    } else {
      areas = c("cfasouth", "cfanorth" )
      regions = c("S-ENS", "N-ENS")
    }

    td = exploitationrates(p=p, areas=areas, labels=regions, CFA4X.exclude.current.year=CFA4X.exclude.current.year )

    n.regions = length(regions)
    npanels = length(areas)
    varstoplot = matrix(ncol=3, byrow=T, data=c( "R0.mass", "Exploitation rate", "") )
    nvarstoplot = dim(varstoplot)[1]
    i=1
    v =  "exploitation.rate"
    tt = varstoplot[i,2]

      yy =  "Proportion of total fishable biomass"
      xlim=range(td$yr); 
      xlim[1]=xlim[1]-0.5; 
      xlim[2]=xlim[2]+0.5
			ylim=range(0, 0.81)

     
    dir.create( outdir, recursive=T, showWarnings=F  )
    fn = file.path( outdir, "exploitation.rate.png"  )
    Cairo( file=fn, type="png", bg="white", width=5, height=6, units="in", dpi=300, pointsize=30 )

      setup.lattice.options()
      
      pl = xyplot( total~yr|region, data=td, ub=td$ub, lb=td$lb, 
        layout=c(1,n.regions), xlim=xlim, ylim=ylim,
        par.strip.text = list(cex=3.0),
        par.settings=list(  
          axis.text=list(cex=2.5), 
          par.main.text = list(cex=4),
          layout.heights=list(strip=0.2, panel=1, main=0.5 ) 
        ),
        main=tt, xlab=list("Year",cex=3), ylab=list(yy,cex=3) ,
        panel = function(x, y, subscripts, ub, lb, ...) {
          larrows(x, lb[subscripts], x, ub[subscripts],  angle = 90, code = 3, length=0.02, lwd=3)
          panel.xyplot(x, y, type="b", lty=1, lwd=6, pch=30, col="black",  ...)
          panel.abline(v=2001.5, col="gray", lty=1, lwd=5, ...)
          panel.abline(h=0, col="black", lty=1, lwd=5, ...)
        }
      )
     print(fn)
     print(pl)
     dev.off()
     cmd( "convert -trim -frame 10x10 -mattecolor white ", fn, fn )
     
     table.view( td )
     return(td)
  }


